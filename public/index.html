<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="keywords" content="todo pwa" />
    <meta name="description" content="todo pwa" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    <title>Todo PWA</title>
    <style>
      .online {
        color: green;
      }

      .off-line {
        color: red;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Todo PWA</h1>
      <p>Network Status: <span id="network-status"></span></p>
      <form id="form">
        <div>
          <input name="text" type="text" />
          <button>Create</button>
        </div>
      </form>
      <div id="list"></div>
    </main>
    <script src="/IndexedDb.js"></script>
    <script src="/Stats.js"></script>
    <script src="/main.js"></script>
    <script>
      window.addEventListener('load', () => {
        const form = document.getElementById('form');
        const dataList = document.getElementById('list');
        const networkStatus = document.getElementById('network-status');
        const stats = new Stats();

        networkStatus.appendChild(stats.domElement);

        window.addEventListener('offline', () => stats.update());
        window.addEventListener('online', () => stats.update());

        async function fetchTodoAndRenderList() {
          try {
            const response = await fetch('/find-all');
            const data = await response.json();
            renderList(data);
          } catch (error) {
            console.error(error);
          }
        }

        function renderList(data) {
          if (data.length <= 0) {
            dataList.innerHTML = '<div>No Data</div>';
            return;
          }
          const listItems = data.map((item) => `<li>${item.text}</li>`).join('');
          dataList.innerHTML = `<ul>${listItems}</ul>`;
        }

        if ('serviceWorker' in navigator && 'indexedDB' in window) {
          const db = new IndexedDB({ name: 'todo', version: 1, storeName: 'todos' });
          db.open().finally(async () => {
            if (!stats.online && db.connected) {
              const data = await db.getAll();
              renderList(data);
            } else {
              fetchTodoAndRenderList();
            }
          });

          async function triggerBackgroundSync() {
            try {
              const registration = await navigator.serviceWorker.ready;
              await registration.sync.register('trigger sync');
              console.log('%c request synchronization', 'color: #5C3B02');
            } catch (error) {
              console.error(error);
            }
          }

          if (stats.online) triggerBackgroundSync();
          window.addEventListener('online', triggerBackgroundSync);

          navigator.serviceWorker.addEventListener('message', (event) => {
            fetchTodoAndRenderList();
            console.log('%c synchronization complete', 'color: #00C9A7');
          });

          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const text = new FormData(event.target).get('text');

            try {
              if (stats.online === false && db.connected) {
                await db.add({ text });
                const data = await db.getAll();
                renderList(data);
              } else {
                await fetch('/create', {
                  method: 'POST',
                  headers: {
                    'content-type': 'application/json',
                  },
                  body: JSON.stringify({ text }),
                });
                fetchTodoAndRenderList();
              }
            } catch (error) {
              console.error(error);
            }
          });
        } else {
          form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const text = new FormData(event.target).get('text');

            try {
              await fetch('/create', {
                method: 'POST',
                headers: {
                  'content-type': 'application/json',
                },
                body: JSON.stringify({ text }),
              });
              fetchTodoAndRenderList();
            } catch (error) {
              console.error(error);
            }
          });
        }
      });
    </script>
  </body>
</html>
